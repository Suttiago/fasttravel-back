{% include "components/head.html"%}

<body class="bg-dark text-white">
  {% include "components/header.html"%}

  <div class="container" style="margin-top: 100px;">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Meus Destinos</h2>
      <!-- Botão para abrir modal de cadastro -->
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#cadastroDestinoModal">
        + Adicionar Destino
      </button>
    </div>

    {% if destinos %}
    <div class="table-responsive">
      <table class="table table-dark table-striped table-bordered align-middle">
        <thead>
          <tr>
            <th>Destino</th>
            <th>Data de Chegada</th>
            <th>Data de Saída</th>
            <th>Adultos</th>
            <th>Crianças</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for destino in destinos %}
          <tr>
            <td>{{ destino.destino }}</td>
            <td>{{ destino.check_in }}</td>
            <td>{{ destino.check_out }}</td>
            <td>{{ destino.adultos }}</td>
            <td>{{ destino.criancas }}</td>
            <td>{{ destino.status or '-' }}</td>
            <td>
              <!-- Excluir -->
              <form action="{{ url_for('destino.excluir_destinos', destino_id=destino.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn btn-danger btn-sm"
                  onclick="return confirm('Tem certeza que deseja excluir este destino?');">
                  <i class="bi bi-trash"></i> 
                </button>
              </form>

              <!-- Editar -->
              <button type="button" class="btn btn-secondary btn-sm" 
                data-bs-toggle="modal" data-bs-target="#editarDestinoModal"
                data-bs-id="{{ destino.id }}"
                data-bs-destino="{{ destino.destino }}"
                data-bs-checkin="{{ destino.check_in }}"
                data-bs-checkout="{{ destino.check_out }}"
                data-bs-adultos="{{ destino.adultos }}"
                data-bs-criancas="{{ destino.criancas }}"
                data-bs-status="{{ destino.status or '' }}">
                <i class="bi bi-pencil-square"></i> 
              </button>

              <button type="button" class="btn btn-info btn-sm" onclick="buscarHoteis({{ destino.id }})">
                <i class="bi bi-search"></i> Hotéis
                </button>

          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-center">Nenhum destino cadastrado.</p>
    {% endif %}
  </div>

  <!-- Modal de Cadastro -->
  <div class="modal fade" id="cadastroDestinoModal" tabindex="-1" aria-labelledby="cadastroDestinoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <form action="/CadastroDestino" method="POST">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header">
            <h5 class="modal-title" id="cadastroDestinoModalLabel">Cadastrar Destino</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="destino" class="form-label">Destino</label>
              <input type="text" class="form-control" id="destino" name="destino" required>
            </div>
            <div class="mb-3">
              <label for="data_chegada" class="form-label">Data de Chegada</label>
              <input type="date" class="form-control" id="data_chegada" name="data_chegada" required>
            </div>
            <div class="mb-3">
              <label for="data_saida" class="form-label">Data de Saída</label>
              <input type="date" class="form-control" id="data_saida" name="data_saida" required>
            </div>
            <div class="mb-3">
              <label for="adultos" class="form-label">Adultos</label>
              <input type="number" class="form-control" id="adultos" name="adultos" min="1" required>
            </div>
            <div class="mb-3">
              <label for="criancas" class="form-label">Crianças</label>
              <input type="number" class="form-control" id="criancas" name="criancas" min="0" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-secondary">Cadastrar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Edição -->
  <div class="modal fade" id="editarDestinoModal" tabindex="-1" aria-labelledby="editarDestinoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" id="formEditarDestino">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header">
            <h5 class="modal-title" id="editarDestinoModalLabel">Editar Destino</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="destino_id" id="edit-destino-id">
            <div class="mb-3">
              <label for="edit-destino" class="form-label">Destino</label>
              <input type="text" class="form-control" id="edit-destino" name="destino" required>
            </div>
            <div class="mb-3">
              <label for="edit-checkin" class="form-label">Data de Chegada</label>
              <input type="date" class="form-control" id="edit-checkin" name="check_in" required>
            </div>
            <div class="mb-3">
              <label for="edit-checkout" class="form-label">Data de Saída</label>
              <input type="date" class="form-control" id="edit-checkout" name="check_out" required>
            </div>
            <div class="mb-3">
              <label for="edit-adultos" class="form-label">Adultos</label>
              <input type="number" class="form-control" id="edit-adultos" name="adultos" required>
            </div>
            <div class="mb-3">
              <label for="edit-criancas" class="form-label">Crianças</label>
              <input type="number" class="form-control" id="edit-criancas" name="criancas" required>
            </div>
            <div class="mb-3">
              <label for="edit-status" class="form-label">Status</label>
              <input type="text" class="form-control" id="edit-status" name="status">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger">Salvar Alterações</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Hotéis -->
<div class="modal fade" id="modalHoteis" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Hotéis Encontrados</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="hoteisResultado">
        <p>Buscando hotéis...</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>


  <script>
    const editarDestinoModal = document.getElementById('editarDestinoModal');

    editarDestinoModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      if (!button) return;

      // Pegando os dados do botão
      const id = button.getAttribute('data-bs-id');
      const destino = button.getAttribute('data-bs-destino');
      const checkin = button.getAttribute('data-bs-checkin');
      const checkout = button.getAttribute('data-bs-checkout');
      const adultos = button.getAttribute('data-bs-adultos');
      const criancas = button.getAttribute('data-bs-criancas');
      const status = button.getAttribute('data-bs-status');

      // Inserindo nos campos do modal
      document.getElementById('edit-destino-id').value = id;
      document.getElementById('edit-destino').value = destino;
      document.getElementById('edit-checkin').value = checkin;
      document.getElementById('edit-checkout').value = checkout;
      document.getElementById('edit-adultos').value = adultos;
      document.getElementById('edit-criancas').value = criancas;
      document.getElementById('edit-status').value = status;

      // Atualiza a action do formulário dinamicamente
      document.getElementById('formEditarDestino').action = "/EditarDestino/" + id;
    });
  </script>

  <script>
async function buscarHoteis(destinoId) {
    let modal = new bootstrap.Modal(document.getElementById("modalHoteis"));
    document.getElementById("hoteisResultado").innerHTML = "<p>Carregando hotéis...</p>";
    modal.show();

    try {
        let response = await fetch(`/buscar_hoteis/${destinoId}`, { method: "POST" });
        let data = await response.json();

        if (response.ok) {
            const hoteis = data.ads; 

            if (hoteis && Array.isArray(hoteis) && hoteis.length > 0) {
                let html = "<ul class='list-group list-group-flush'>";
                hoteis.forEach(hotel => {
                    const nome = hotel.name || "Sem nome";
                    const endereco = hotel.address || "Não informado";
                    const preco = hotel.price || "Indisponível";
                    const link = hotel.link;
                    const linkHtml = link ? `<a href="${link}" target="_blank" class="btn btn-primary btn-sm mt-2">Ver Oferta</a>` : '';
                    const thumbnail = hotel.thumbnail ? `<img src="${hotel.thumbnail}" class="img-fluid" alt="Imagem do Hotel">` : '';

                    html += `
                        <li class="list-group-item bg-dark text-white d-flex align-items-center mb-3">
                            <div class="me-3" style="min-width: 100px;">
                                ${thumbnail}
                            </div>
                            <div>
                                <h5>${nome}</h5>
                                <p class="mb-1">Endereço: ${endereco}</p>
                                <p class="mb-1">Preço: ${preco}</p>
                                <p class="mb-0">Avaliação: ${hotel.overall_rating || 'N/A'} (${hotel.reviews || 0} avaliações)</p>
                                ${linkHtml}
                            </div>
                        </li>`;
                });
                html += "</ul>";
                document.getElementById("hoteisResultado").innerHTML = html;
            } else {
                document.getElementById("hoteisResultado").innerHTML = "<p>Nenhum hotel encontrado.</p>";
            }
        } else {
            // Se a resposta da API não for 200 (OK), exibe a mensagem de erro
            document.getElementById("hoteisResultado").innerHTML = `<p class="text-danger">${data.error}</p>`;
        }
    } catch (err) {
        console.error("Erro na requisição:", err);
        document.getElementById("hoteisResultado").innerHTML = "<p class='text-danger'>Erro ao buscar hotéis.</p>";
    }
}
</script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
